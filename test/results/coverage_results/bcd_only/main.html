<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>main</title></head>
<body>
<h1>main.sail (15/23) 65%</h1>
<code style="display: block">
default&nbsp;Order&nbsp;dec<br>
$include&nbsp;&lt;prelude.sail&gt;<br>
$include&nbsp;&quot;types.sail&quot;<br>
$include&nbsp;&quot;prelude.sail&quot;<br>
$include&nbsp;&quot;registers.sail&quot;<br>
$include&nbsp;&quot;interrupts.sail&quot;<br>
$include&nbsp;&quot;addressing.sail&quot;<br>
$include&nbsp;&quot;decimal-mode.sail&quot;<br>
$include&nbsp;&quot;instruction-ast.sail&quot;<br>
$include&nbsp;&quot;decode.sail&quot;<br>
$include&nbsp;&quot;config.sail&quot;<br>
$include&nbsp;&quot;assembly-print.sail&quot;<br>
<br>
val&nbsp;print_state&nbsp;:&nbsp;(int)&nbsp;-&gt;&nbsp;unit<br>
function&nbsp;print_state(cycles_taken)&nbsp;=&nbsp;<span style="background-color: hsl(0, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;A:&nbsp;&quot;,&nbsp;reg_A);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;X:&nbsp;&quot;,&nbsp;reg_X);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;Y:&nbsp;&quot;,&nbsp;reg_Y);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;SP:&nbsp;&quot;,&nbsp;reg_SP);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;PC:&nbsp;&quot;,&nbsp;reg_PC);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;n:&nbsp;&quot;,&nbsp;reg_SR[n]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;v:&nbsp;&quot;,&nbsp;reg_SR[v]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;b:&nbsp;&quot;,&nbsp;reg_SR[b]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;d:&nbsp;&quot;,&nbsp;reg_SR[d]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;i:&nbsp;&quot;,&nbsp;reg_SR[i]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;z:&nbsp;&quot;,&nbsp;reg_SR[z]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;c:&nbsp;&quot;,&nbsp;reg_SR[c]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_endline(concat_str(&quot;cycles:&nbsp;&quot;,&nbsp;dec_str(cycles_taken)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_endline(concat_str(&quot;total&nbsp;cycles:&nbsp;&quot;,&nbsp;dec_str(cycles)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_endline(concat_str(&quot;total&nbsp;instructions:&nbsp;&quot;,&nbsp;dec_str(instructions_done)));<br>
}</span><br>
<br>
function&nbsp;fetch_decode_execute()&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;bool&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;check_for_interrupt();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;start_PC&nbsp;:&nbsp;address&nbsp;=&nbsp;reg_PC;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;cycles_before&nbsp;:&nbsp;int&nbsp;=&nbsp;cycles;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;instruction&nbsp;=&nbsp;read(start_PC);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;incr_pc(1);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;decoded&nbsp;=&nbsp;decode(instruction);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;execute_success&nbsp;=&nbsp;execute(decoded);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;(execute_success)&nbsp;then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 70%)">instructions_done&nbsp;=&nbsp;instructions_done&nbsp;+&nbsp;1</span></span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;asm&nbsp;=&nbsp;assembly(start_PC,&nbsp;decoded);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;(enable_print_dump)&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_endline(concat_str(&quot;\n&quot;,&nbsp;concat_str(bits_str(start_PC),&nbsp;concat_str(&quot;&nbsp;&quot;,&nbsp;asm))));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_state(cycles&nbsp;-&nbsp;cycles_before);<br>
&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;enable_print_at_interval&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(0, 85%, 75%)">if&nbsp;(instructions_done&nbsp;%&nbsp;1000&nbsp;==&nbsp;0)&nbsp;then&nbsp;<span style="background-color: hsl(0, 85%, 70%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_endline(concat_str(&quot;\n&quot;,&nbsp;concat_str(bits_str(start_PC),&nbsp;concat_str(&quot;&nbsp;&quot;,&nbsp;asm))));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_state(cycles&nbsp;-&nbsp;cycles_before);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}</span></span>;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;enable_break_at_trap&nbsp;then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 70%)">if&nbsp;(start_PC&nbsp;==&nbsp;reg_PC)&nbsp;then&nbsp;<span style="background-color: hsl(120, 85%, 65%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_bits(&quot;trapped&nbsp;PC:&nbsp;&quot;,&nbsp;start_PC);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></span></span>;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;execute_success;<br>
}</span><br>
<br>
//&nbsp;PC&nbsp;is&nbsp;read&nbsp;from&nbsp;address&nbsp;provided&nbsp;in&nbsp;reset&nbsp;vector&nbsp;(16&nbsp;bits&nbsp;at&nbsp;$FFFC).<br>
//&nbsp;All&nbsp;other&nbsp;initialization&nbsp;is&nbsp;left&nbsp;to&nbsp;the&nbsp;program&nbsp;loaded.<br>
function&nbsp;model_init()&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;unit&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;PCH&nbsp;:&nbsp;word&nbsp;=&nbsp;read(RST_vec&nbsp;+&nbsp;1);<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;PCL&nbsp;:&nbsp;word&nbsp;=&nbsp;read(RST_vec);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;reg_PC[15..8]&nbsp;=&nbsp;PCH;<br>
&nbsp;&nbsp;&nbsp;&nbsp;reg_PC[7..0]&nbsp;&nbsp;=&nbsp;PCL;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;reg_A&nbsp;&nbsp;=&nbsp;undefined;<br>
&nbsp;&nbsp;&nbsp;&nbsp;reg_X&nbsp;&nbsp;=&nbsp;undefined;<br>
&nbsp;&nbsp;&nbsp;&nbsp;reg_Y&nbsp;&nbsp;=&nbsp;undefined;<br>
&nbsp;&nbsp;&nbsp;&nbsp;reg_SP&nbsp;=&nbsp;undefined;<br>
&nbsp;&nbsp;&nbsp;&nbsp;reg_SR[all]&nbsp;=&nbsp;undefined;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;cycles&nbsp;=&nbsp;0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;instructions_done&nbsp;=&nbsp;0;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;NMI&nbsp;=&nbsp;0b1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;RST&nbsp;=&nbsp;0b1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;IRQ&nbsp;=&nbsp;0b1;<br>
}</span><br>
<br>
function&nbsp;main()&nbsp;:&nbsp;unit&nbsp;-&gt;&nbsp;unit&nbsp;=&nbsp;<span style="background-color: hsl(120, 85%, 80%)">{<br>
&nbsp;&nbsp;&nbsp;&nbsp;mem_init();<br>
&nbsp;&nbsp;&nbsp;&nbsp;load_binary();<br>
&nbsp;&nbsp;&nbsp;&nbsp;model_init();<br>
&nbsp;&nbsp;&nbsp;&nbsp;load_config();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(fetch_decode_execute())&nbsp;do&nbsp;{()};<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 75%)">if&nbsp;enable_print_mem&nbsp;then<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="background-color: hsl(120, 85%, 70%)">print_memory()</span></span><span style="background-color: hsl(0, 85%, 80%)">&#171;Invisible branch not taken here&#187</span>;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_endline(concat_str(&quot;total&nbsp;cycle&nbsp;count:&nbsp;&quot;,&nbsp;dec_str(cycles)));<br>
&nbsp;&nbsp;&nbsp;&nbsp;print_endline(concat_str(&quot;total&nbsp;instructions:&nbsp;&quot;,&nbsp;dec_str(instructions_done)));<br>
}</span><br>
</code>
</body>
</html>